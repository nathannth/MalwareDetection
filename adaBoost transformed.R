pacman::p_load(caTools, stargazer, caret, car, adabag, dplyr, tibble, mice, Hmisc)

setwd("C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/MAST_Column/20200924")

mal.dist.files.exe = read.csv("Subset_Distinct_EXE_Transformed.csv")
mal.dist.files.nonexe = read.csv("Subset_Distinct_NonEXE_Transformed.csv")
mal.dist.url = read.csv("Subset_Distinct_URLs_Transformed.csv")

# Specifying which columns would be useful for different types of analysis based on 
# domain knowledge and EDA (those with many NAs are dropped)

str(mal.dist.urls)

exe_column = c("threat_level","size_log", "total_network_connections",
                 "sqrt_total_processes","sqrt_total_signatures",".bss",".data",".idata",
                 ".rsrc",".tls",".text", "environment_id", "name.length")

nonexe_column = c("threat_level","size_log", "sqrt_total_network_connections",
                  "sqrt_total_processes","sqrt_total_signatures", "environment_id", "name.length")

url_column = c("threat_level","sqrt_total_network_connections", "sqrt_total_processes",
               "sqrt_total_signatures", "environment_id", "name.length")

# Creating new data frames to store the datasets for model building
# One for non-exe, one for URL, and another one for just EXE files as
# proof of concept
mal.dist.files.nonexe.num <- mal.dist.files.nonexe[,nonexe_column]
mal.dist.files.exe.num <- mal.dist.files.exe[,exe_column]
mal.dist.url.num <- mal.dist.url[,url_column]

md.pattern(mal.dist.files.nonexe.num)
md.pattern(mal.dist.files.exe.num)
md.pattern(mal.dist.url.num)

# Refactor the threat_level as there's an unused column
mal.dist.url.num$threat_level <- factor(mal.dist.url.num$threat_level)
mal.dist.files.exe.num$threat_level <- factor(mal.dist.files.exe.num$threat_level)
mal.dist.files.nonexe.num$threat_level <- factor(mal.dist.files.nonexe.num$threat_level)

# Part 2: Fitting the model - a.Observe the goodness of fit, t-stat; b.Use AIC step (optional) to select best variables
#set initial seed
set.seed(532)

# create a boolean flag to split data
# sample.split from caTools
split.exe = sample.split(mal.dist.files.exe.num$threat_level, SplitRatio = 0.7)
split.nonexe = sample.split(mal.dist.files.nonexe.num$threat_level, SplitRatio = 0.7)
split.url = sample.split(mal.dist.url.num$threat_level, SplitRatio = 0.7)


#output all the training and testing sets to be used for other models
write.csv(split.exe,"C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/Train and Test Split/20200924\\Exe Split.csv", row.names = FALSE)
write.csv(split.nonexe,"C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/Train and Test Split/20200924\\Non-Exe.csv", row.names = FALSE)
write.csv(split.url,"C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/Train and Test Split/20200924\\Url.csv", row.names = FALSE)

# Split the data into training and testing data sets
# create training data set
exe_training_set = mal.dist.files.exe.num[split.exe,]
nonexe_training_set = mal.dist.files.nonexe.num[split.nonexe,]
url_training_set = mal.dist.url.num[split.url,]

# Check ratio of the split
nrow(exe_training_set)/nrow(mal.dist.files.exe.num)
nrow(nonexe_training_set)/nrow(mal.dist.files.nonexe.num)
nrow(url_training_set)/nrow(mal.dist.url.num)

# create testing data set
exe_testing_set = mal.dist.files.exe.num[!split.exe,]
nonexe_testing_set = mal.dist.files.nonexe.num[!split.nonexe,]
url_testing_set = mal.dist.url.num[!split.url,]

#Creating AdaBoost model
#There are 2 parameters, number of iterations (mfinal) and cross-validation subset (v) 

set.seed(532)

#returns the performance in a df, creates global variable of ada.model and ada.result
adaboost_function <- function (mfinal_input, type, training, testing){
  
  ada.model <<- boosting(threat_level~., data=training, boos = TRUE, mfinal = mfinal_input, coeflearn = type)
  ada.result <<- predict(ada.model, testing)
  ada.result$class <<- as.factor(ada.result$class)
  
  cm = confusionMatrix(ada.result$class, testing$threat_level, positive = NULL, dnn = c("Prediction", "Actual"))
  
  #Overall accuracy
  acc = cm$overall["Accuracy"]
  
  if(nrow(cm$table) < 4){
    cm.pred0act0 = cm$table["0","0"]
    cm.pred0act1 = cm$table["0","1"]
    cm.pred0act2 = cm$table["0","2"]
    cm.pred0act3 = 0
    cm.pred1act0 = cm$table["1","0"]
    cm.pred1act1 = cm$table["1","1"]
    cm.pred1act2 = cm$table["1","2"]
    cm.pred1act3 = 0
    cm.pred2act0 = cm$table["2","0"]
    cm.pred2act1 = cm$table["2","1"]
    cm.pred2act2 = cm$table["2","2"]
    cm.pred2act3 = 0
    cm.pred3act0 = 0
    cm.pred3act1 = 0
    cm.pred3act2 = 0
    cm.pred3act3 = 0
    }
    else{
      cm.pred0act0 = cm$table["0","0"]
      cm.pred0act1 = cm$table["0","1"]
      cm.pred0act2 = cm$table["0","2"]
      cm.pred0act3 = cm$table["0","3"]
      cm.pred1act0 = cm$table["1","0"]
      cm.pred1act1 = cm$table["1","1"]
      cm.pred1act2 = cm$table["1","2"]
      cm.pred1act3 = cm$table["1","3"]
      cm.pred2act0 = cm$table["2","0"]
      cm.pred2act1 = cm$table["2","1"]
      cm.pred2act2 = cm$table["2","2"]
      cm.pred2act3 = cm$table["2","3"]
      cm.pred3act0 = cm$table["3","0"]
      cm.pred3act1 = cm$table["3","1"]
      cm.pred3act2 = cm$table["3","2"]
      cm.pred3act3 = cm$table["3","3"]
      }
  
  result.df = data.frame(mfinal_input, type, acc, 
                         cm.pred0act0, cm.pred0act1, cm.pred0act2, cm.pred0act3,
                         cm.pred1act0, cm.pred1act1, cm.pred1act2, cm.pred1act3,
                         cm.pred2act0, cm.pred2act1, cm.pred2act2, cm.pred2act3,
                         cm.pred3act0, cm.pred3act1, cm.pred3act2, cm.pred3act3,
                         row.names = NULL)

  return (result.df)
}



## exe file

ada.result.df = adaboost_function(200,"Breiman",exe_training_set,exe_testing_set)
ada.model.exe = ada.model
ada.result.exe = ada.result
confusionMatrix(ada.result.exe$class, exe_testing_set$threat_level, positive = NULL, dnn = c("Prediction", "Actual"))
par(mar=c(5.1,12.1,4.1,2.1))
importanceplot(ada.model.exe, horiz=TRUE, cex.names =1)

score_exe = data.frame(exe_testing_set$threat_level, ada.result.exe$class)
write.csv(score_exe,"C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/AdaBoost/Score (Transformed)\\Score (200 Breiman) (Exe).csv", row.names = FALSE)


## non-exe file
ada.result.nonexe.df = adaboost_function(200,"Breiman",nonexe_training_set,nonexe_testing_set)
ada.model.nonexe = ada.model
ada.result.nonexe = ada.result
confusionMatrix(ada.result.nonexe$class, nonexe_testing_set$threat_level, positive = NULL, dnn = c("Prediction", "Actual"))
par(mar=c(5.1,12.1,4.1,2.1))
importanceplot(ada.model.nonexe, horiz=TRUE, cex.names =1)

score_nonexe = data.frame(nonexe_testing_set$threat_level, ada.result.nonexe$class)
write.csv(score_nonexe,"C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/AdaBoost/Score (Transformed)\\Score (200 Breiman) (Non-Exe).csv", row.names = FALSE)



## URL
ada.result.url.df = adaboost_function(150,"Breiman", url_training_set, url_testing_set)
ada.model.url = ada.model
ada.result.url = ada.result
confusionMatrix(ada.result.url$class, url_testing_set$threat_level, positive = NULL, dnn = c("Prediction", "Actual"))
par(mar=c(5.1,12.1,4.1,2.1))
importanceplot(ada.model.url, horiz=TRUE, cex.names =1)

score_url = data.frame(url_testing_set$threat_level, ada.result.url$class)
write.csv(score_url,"C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/AdaBoost/Score (Transformed)\\Score (150 Breiman) (URL).csv", row.names = FALSE)


#==========================================================================

#Apply the function across various parameters. Initialise the dataframe.
result.ada.df = data.frame(mfinal_input=integer(0), type=character(0), acc=numeric(0),
                           cm.pred0act0 = numeric(0),
                           cm.pred0act1 = numeric(0),
                           cm.pred0act2 = numeric(0),
                           cm.pred0act3 = numeric(0),
                           cm.pred1act0 = numeric(0),
                           cm.pred1act1 = numeric(0),
                           cm.pred1act2 = numeric(0),
                           cm.pred1act3 = numeric(0),
                           cm.pred2act0 = numeric(0),
                           cm.pred2act1 = numeric(0),
                           cm.pred2act2 = numeric(0),
                           cm.pred2act3 = numeric(0),
                           cm.pred3act0 = numeric(0),
                           cm.pred3act1 = numeric(0),
                           cm.pred3act2 = numeric(0),
                           cm.pred3act3 = numeric(0))

parameterTuning <- function(training, testing){
  for (mfinal in seq(from=150, to=250, by=50)){
    for (type in c("Breiman", "Freund", "Zhu")){
      result.ada.df = result.ada.df %>% add_row(adaboost_function(mfinal, type, training, testing))
    }
  }
  return (result.ada.df)
}


performance.exe = parameterTuning(exe_training_set, exe_testing_set)

performance.exe


write.csv(performance.exe,"C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/AdaBoost\\AdaBoost Performance (Exe).csv", row.names = FALSE)


performance.nonexe = parameterTuning(nonexe_training_set, nonexe_testing_set)

performance.nonexe

write.csv(performance.nonexe,"C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/AdaBoost\\AdaBoost Performance (Non-Exe).csv", row.names = FALSE)


performance.url = parameterTuning(url_training_set, url_testing_set)
performance.url
write.csv(performance.url,"C:/Users/natha/National University of Singapore/Peng Zanyu - EBA Project/05 Data Cleaning/AdaBoost\\AdaBoost Performance2 (URL).csv", row.names = FALSE)


